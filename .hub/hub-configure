#!/bin/bash

echo "  ____                        _           _      _       ";
echo " / ___| _   _ _ __   ___ _ __| |__  _   _| |__  (_) ___  ";
echo " \___ \| | | | '_ \ / _ \ '__| '_ \| | | | '_ \ | |/ _ \ ";
echo "  ___) | |_| | |_) |  __/ |  | | | | |_| | |_) || | (_) |";
echo " |____/ \__,_| .__/ \___|_|  |_| |_|\__,_|_.__(_)_|\___/ ";
echo "             |_|                                         ";

BUBBLES="https://api.app.vou8.dev.superhub.io/dns"
ASI_DOMAIN="dev.superhub.io"

if [ ! -f ".env" ]; then
  META=$(curl -s -X POST \
    "$BUBBLES" \
    -H 'Content-Type: application/json;charset=UTF-8' \
    -d "{\"baseDomain\": \"$ASI_DOMAIN\"}")

  if [ -z "$AWS_PROFILE" ]; then
    export AWS_PROFILE=default
  fi

  if [ -z "$AWS_REGION" ]; then
    export AWS_REGION=us-east-1
  fi

  DOMAIN_NAME=$(echo "$META" | jq -r .domain)

  cat <<EOF > .env
#!/bin/bash

# AWS Profile and AWS region where  (editable)
export AWS_PROFILE=$AWS_PROFILE
export AWS_REGION=$AWS_REGION

# Name of Kubernetes Platform (generated by Agile Stacks)
export PLATFORM_NAME=$(echo "$DOMAIN_NAME" | cut -d. -f1)

# Parent domain of the platform (provided by Agile Stacks)
export BASE_DOMAIN=$ASI_DOMAIN
export DOMAIN_KEY=$(echo "$META" | jq -r .key)

# Name and region of S3 bucket where state of provsisioned components will be stored
export STATE_BUCKET=agilestacks.$DOMAIN_NAME
export STATE_REGION=$AWS_REGION

EOF
  echo
  echo Platform name: "$DOMAIN_NAME"
  echo
fi

echo
echo "Parameter file .env: "
echo
cat .env
echo
